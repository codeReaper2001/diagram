<mxfile host="65bd71144e">
    <diagram id="YsbbRHAP8pMQUdsHkCIG" name="第 1 页">
        <mxGraphModel dx="968" dy="558" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
            <root>
                <mxCell id="0"/>
                <mxCell id="1" parent="0"/>
                <mxCell id="89" style="edgeStyle=orthogonalEdgeStyle;rounded=0;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;fontColor=#000000;dashed=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="86" target="88">
                    <mxGeometry relative="1" as="geometry">
                        <mxPoint x="580" y="1630" as="targetPoint"/>
                        <Array as="points">
                            <mxPoint x="330" y="1740"/>
                            <mxPoint x="330" y="1590"/>
                        </Array>
                    </mxGeometry>
                </mxCell>
                <mxCell id="6" style="edgeStyle=none;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;sketch=1;" parent="1" source="2" target="4" edge="1">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="7" style="edgeStyle=none;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;sketch=1;" parent="1" source="2" target="5" edge="1">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="2" value="Redis数据持久化机制" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#f8cecc;strokeColor=#b85450;" parent="1" vertex="1">
                    <mxGeometry x="40" y="60" width="130" height="40" as="geometry"/>
                </mxCell>
                <mxCell id="4" value="AOF日志" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
                    <mxGeometry x="280" y="30" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="5" value="RDB快照" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
                    <mxGeometry x="280" y="90" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="13" style="edgeStyle=none;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;sketch=1;" edge="1" parent="1" source="9" target="12">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="9" value="开启方式" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#b0e3e6;strokeColor=#0e8088;" vertex="1" parent="1">
                    <mxGeometry x="40" y="253.46" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="12" value="" style="shape=image;imageAspect=0;aspect=fixed;verticalLabelPosition=bottom;verticalAlign=top;image=https://codereaper-image-bed.oss-cn-shenzhen.aliyuncs.com/img/0e2d081af084c41802c7b5de8aa41bd4.png;imageBorder=default;sketch=1;" vertex="1" parent="1">
                    <mxGeometry x="200" y="217.85" width="470" height="101.23" as="geometry"/>
                </mxCell>
                <mxCell id="14" value="&lt;div style=&quot;text-align: left&quot;&gt;&lt;span&gt;参考资料：&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;&lt;span&gt;https://xiaolincoding.com/redis/storage/aof.html&lt;/span&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#ffe6cc;strokeColor=#d79b00;sketch=1;" vertex="1" parent="1">
                    <mxGeometry x="440" y="30" width="270" height="40" as="geometry"/>
                </mxCell>
                <mxCell id="15" value="AOF日志" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#fad9d5;strokeColor=#ae4132;" vertex="1" parent="1">
                    <mxGeometry x="369" y="160" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="18" style="edgeStyle=none;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="16" target="17">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="29" style="edgeStyle=none;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="16" target="28">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="37" style="edgeStyle=none;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="16" target="36">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="16" value="执行机制" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#ffe6cc;strokeColor=#d79b00;" vertex="1" parent="1">
                    <mxGeometry x="40" y="710" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="17" value="" style="shape=image;imageAspect=0;aspect=fixed;verticalLabelPosition=bottom;verticalAlign=top;sketch=1;image=https://codereaper-image-bed.oss-cn-shenzhen.aliyuncs.com/img/6f0ab40396b7fc2c15e6f4487d3a0ad7.png;imageBorder=default;" vertex="1" parent="1">
                    <mxGeometry x="200" y="490" width="381.15" height="140" as="geometry"/>
                </mxCell>
                <mxCell id="21" style="edgeStyle=none;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="19" target="20">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="19" value="日志格式" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#ffe6cc;strokeColor=#d79b00;" vertex="1" parent="1">
                    <mxGeometry x="40" y="382.00000000000006" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="23" style="edgeStyle=none;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="20" target="22">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="25" style="edgeStyle=none;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="20" target="24">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="27" style="edgeStyle=none;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="20" target="26">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="20" value="" style="shape=image;imageAspect=0;aspect=fixed;verticalLabelPosition=bottom;verticalAlign=top;sketch=1;image=https://codereaper-image-bed.oss-cn-shenzhen.aliyuncs.com/img/image-20220730183807003.png;imageBorder=default;" vertex="1" parent="1">
                    <mxGeometry x="200" y="340" width="139.82" height="114" as="geometry"/>
                </mxCell>
                <mxCell id="22" value="*{n}：表示命令有n个部分" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="1">
                    <mxGeometry x="414" y="340" width="156" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="24" value="${length}：表示当前部分的字节数" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="1">
                    <mxGeometry x="414" y="382" width="196" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="26" value="${length}后面的内容：该部分的值" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="1">
                    <mxGeometry x="414" y="424" width="196" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="31" style="edgeStyle=none;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="28" target="30">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="33" style="edgeStyle=none;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="28" target="32">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="28" value="先执行写操作命令，后记录日志的优点" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
                    <mxGeometry x="200" y="700" width="120" height="50" as="geometry"/>
                </mxCell>
                <mxCell id="42" style="edgeStyle=none;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="30" target="34">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="30" value="避免额外的检查开销" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="1">
                    <mxGeometry x="390" y="665" width="130" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="43" style="edgeStyle=none;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="32" target="35">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="32" value="不会阻塞当前写操作命令的执行" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="1">
                    <mxGeometry x="390" y="730" width="130" height="40" as="geometry"/>
                </mxCell>
                <mxCell id="34" value="如果&lt;b&gt;先执行写操作命令再记录日志的话&lt;/b&gt;，只有在该命令执行成功后，才将命令记录到 AOF 日志里，这样就不用额外的检查开销，&lt;b&gt;保证记录在 AOF 日志里的命令都是可执行并且正确的&lt;/b&gt;" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#ffe6cc;strokeColor=#d79b00;sketch=1;" vertex="1" parent="1">
                    <mxGeometry x="550" y="640" width="210" height="80" as="geometry"/>
                </mxCell>
                <mxCell id="35" value="当写操作命令执行成功后，才会将命令记录到 AOF 日志" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#ffe6cc;strokeColor=#d79b00;sketch=1;" vertex="1" parent="1">
                    <mxGeometry x="550" y="730" width="160" height="40" as="geometry"/>
                </mxCell>
                <mxCell id="39" style="edgeStyle=none;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="36" target="38">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="45" style="edgeStyle=none;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="36" target="44">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="36" value="潜在风险" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#b1ddf0;strokeColor=#10739e;" vertex="1" parent="1">
                    <mxGeometry x="224.91" y="850" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="41" style="edgeStyle=none;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="38" target="40">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="38" value="数据丢失" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="1">
                    <mxGeometry x="369.00000000000006" y="810" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="40" value="&lt;div style=&quot;text-align: left&quot;&gt;&lt;span&gt;时机：&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;&lt;span&gt;① Redis执行完某写命令&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;&lt;span&gt;② 写入AOF日志时宕机&lt;/span&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#ffe6cc;strokeColor=#d79b00;sketch=1;" vertex="1" parent="1">
                    <mxGeometry x="500.57" y="800" width="148.85" height="50" as="geometry"/>
                </mxCell>
                <mxCell id="47" style="edgeStyle=none;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="44" target="46">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="44" value="阻塞下一个命令的执行" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="1">
                    <mxGeometry x="369" y="880" width="91" height="40" as="geometry"/>
                </mxCell>
                <mxCell id="49" style="edgeStyle=none;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="46" target="48">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="51" style="edgeStyle=none;sketch=1;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;dashed=1;" edge="1" parent="1" source="46" target="50">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="46" value="&lt;div style=&quot;text-align: left&quot;&gt;&lt;span&gt;时机：&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;&lt;span&gt;① 执行完命令1后日志写入磁盘，磁盘IO压力大&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;&lt;span&gt;② 命令2的执行被阻塞&lt;/span&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#ffe6cc;strokeColor=#d79b00;sketch=1;" vertex="1" parent="1">
                    <mxGeometry x="500.57" y="867.5" width="148.85" height="65" as="geometry"/>
                </mxCell>
                <mxCell id="48" value="" style="shape=image;imageAspect=0;aspect=fixed;verticalLabelPosition=bottom;verticalAlign=top;sketch=1;image=https://codereaper-image-bed.oss-cn-shenzhen.aliyuncs.com/img/28afd536c57a46447ddab0a2062abe84.png;imageBorder=default;" vertex="1" parent="1">
                    <mxGeometry x="720" y="760" width="207.31" height="280" as="geometry"/>
                </mxCell>
                <mxCell id="53" style="edgeStyle=orthogonalEdgeStyle;sketch=1;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;dashed=1;rounded=0;" edge="1" parent="1" source="50" target="52">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="50" value="&lt;div style=&quot;text-align: left&quot;&gt;磁盘IO的压力主要与AOF写回策略有关，根据情况调节&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#dae8fc;strokeColor=#6c8ebf;sketch=1;" vertex="1" parent="1">
                    <mxGeometry x="500.57" y="970" width="148.85" height="50" as="geometry"/>
                </mxCell>
                <mxCell id="57" style="rounded=0;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="52" target="54">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="58" style="edgeStyle=none;rounded=0;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="52" target="55">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="59" style="edgeStyle=none;rounded=0;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="52" target="56">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="52" value="AOF写回策略" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#ffe6cc;strokeColor=#d79b00;" vertex="1" parent="1">
                    <mxGeometry x="40" y="1117.5" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="61" style="edgeStyle=none;rounded=0;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="54" target="60">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="54" value="Always" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
                    <mxGeometry x="224.91" y="1060" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="63" style="edgeStyle=none;rounded=0;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="55" target="62">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="55" value="Everysec" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
                    <mxGeometry x="224.91" y="1117.5" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="67" style="edgeStyle=none;rounded=0;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="56" target="66">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="56" value="No" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
                    <mxGeometry x="224.91" y="1180" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="60" value="每次写操作命令执行完后，&lt;b&gt;同步&lt;/b&gt;将 AOF 日志数据&lt;b&gt;写回硬盘&lt;/b&gt;" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#ffe6cc;strokeColor=#d79b00;sketch=1;" vertex="1" parent="1">
                    <mxGeometry x="369" y="1055" width="170" height="40" as="geometry"/>
                </mxCell>
                <mxCell id="62" value="每次写操作命令执行完后：&lt;br&gt;① 将命令写入到 AOF 文件的&lt;b&gt;内核缓冲区&lt;/b&gt;&lt;br&gt;② 每隔一秒将缓冲区里的内容写回到硬盘" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#ffe6cc;strokeColor=#d79b00;sketch=1;align=left;" vertex="1" parent="1">
                    <mxGeometry x="370" y="1105" width="240" height="55" as="geometry"/>
                </mxCell>
                <mxCell id="66" value="每次写操作命令执行完后：&lt;br&gt;① 将命令写入到 AOF 文件的&lt;b&gt;内核缓冲区&lt;/b&gt;&lt;br&gt;② 再由&lt;b&gt;操作系统决定&lt;/b&gt;何时将缓冲区内容写回硬盘" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#ffe6cc;strokeColor=#d79b00;sketch=1;align=left;" vertex="1" parent="1">
                    <mxGeometry x="369" y="1169" width="271" height="55" as="geometry"/>
                </mxCell>
                <mxCell id="78" style="edgeStyle=none;rounded=0;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontColor=#6262FC;" edge="1" parent="1" source="69" target="68">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="77" value="" style="group" vertex="1" connectable="0" parent="1">
                    <mxGeometry x="199.99999999999994" y="1250" width="343.5" height="390" as="geometry"/>
                </mxCell>
                <mxCell id="68" value="" style="shape=image;imageAspect=0;aspect=fixed;verticalLabelPosition=bottom;verticalAlign=top;sketch=1;image=https://codereaper-image-bed.oss-cn-shenzhen.aliyuncs.com/img/4eeef4dd1bedd2ffe0b84d4eaa0dbdea.png;imageBorder=default;" vertex="1" parent="77">
                    <mxGeometry width="343.5" height="390" as="geometry"/>
                </mxCell>
                <mxCell id="71" value="" style="rounded=0;whiteSpace=wrap;html=1;comic=0;fillColor=none;strokeColor=#b85450;" vertex="1" parent="77">
                    <mxGeometry x="96" y="57" width="140" height="60" as="geometry"/>
                </mxCell>
                <mxCell id="72" value="&lt;font color=&quot;#6262fc&quot;&gt;1）&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=none;strokeColor=none;" vertex="1" parent="77">
                    <mxGeometry x="40" y="72" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="73" value="" style="rounded=0;whiteSpace=wrap;html=1;comic=0;fillColor=none;strokeColor=#b85450;" vertex="1" parent="77">
                    <mxGeometry x="96" y="128" width="140" height="130" as="geometry"/>
                </mxCell>
                <mxCell id="74" value="&lt;font color=&quot;#6262fc&quot;&gt;2）&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=none;strokeColor=none;" vertex="1" parent="77">
                    <mxGeometry x="40" y="190" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="75" value="" style="rounded=0;whiteSpace=wrap;html=1;comic=0;fillColor=none;strokeColor=#b85450;" vertex="1" parent="77">
                    <mxGeometry x="92" y="268" width="144" height="50" as="geometry"/>
                </mxCell>
                <mxCell id="76" value="&lt;font color=&quot;#6262fc&quot;&gt;3）&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=none;strokeColor=none;" vertex="1" parent="77">
                    <mxGeometry x="65" y="278" width="40" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="79" style="edgeStyle=orthogonalEdgeStyle;rounded=0;sketch=1;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontColor=#6262FC;dashed=1;" edge="1" parent="1" source="52" target="76">
                    <mxGeometry relative="1" as="geometry">
                        <Array as="points">
                            <mxPoint x="85" y="1543"/>
                        </Array>
                    </mxGeometry>
                </mxCell>
                <mxCell id="80" value="&lt;font color=&quot;#000000&quot;&gt;决定&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontColor=#6262FC;" vertex="1" connectable="0" parent="79">
                    <mxGeometry x="-0.4882" relative="1" as="geometry">
                        <mxPoint as="offset"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="69" value="操作过程" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#ffe6cc;strokeColor=#d79b00;" vertex="1" parent="1">
                    <mxGeometry x="40" y="1430" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="81" value="最大程度保证数据不丢失；性能最低" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#f8cecc;strokeColor=#b85450;sketch=1;" vertex="1" parent="1">
                    <mxGeometry x="660" y="1055" width="230" height="40" as="geometry"/>
                </mxCell>
                <mxCell id="82" value="宕机丢失数据最多；性能最高" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#f8cecc;strokeColor=#b85450;sketch=1;" vertex="1" parent="1">
                    <mxGeometry x="660" y="1176.5" width="230" height="40" as="geometry"/>
                </mxCell>
                <mxCell id="83" value="折中；折中" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#f8cecc;strokeColor=#b85450;sketch=1;" vertex="1" parent="1">
                    <mxGeometry x="660" y="1112.5" width="230" height="40" as="geometry"/>
                </mxCell>
                <mxCell id="84" value="" style="shape=image;imageAspect=0;aspect=fixed;verticalLabelPosition=bottom;verticalAlign=top;comic=0;sketch=1;fontColor=#000000;fillColor=none;image=https://codereaper-image-bed.oss-cn-shenzhen.aliyuncs.com/img/98987d9417b2bab43087f45fc959d32a.png;imageBorder=default;" vertex="1" parent="1">
                    <mxGeometry x="568.17" y="1254.99" width="413.66" height="175.01" as="geometry"/>
                </mxCell>
                <mxCell id="87" style="edgeStyle=orthogonalEdgeStyle;rounded=0;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontColor=#000000;" edge="1" parent="1" source="85" target="86">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="85" value="三种策略的底层实现" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#ffe6cc;strokeColor=#d79b00;" vertex="1" parent="1">
                    <mxGeometry x="40" y="1720" width="90" height="40" as="geometry"/>
                </mxCell>
                <mxCell id="91" style="rounded=0;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontColor=#000000;" edge="1" parent="1" source="86" target="90">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="86" value="控制fsysc()系统调用的调用时机" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#b0e3e6;strokeColor=#0e8088;" vertex="1" parent="1">
                    <mxGeometry x="180" y="1720" width="100" height="40" as="geometry"/>
                </mxCell>
                <mxCell id="88" value="" style="shape=image;imageAspect=0;aspect=fixed;verticalLabelPosition=bottom;verticalAlign=top;comic=0;sketch=1;fontColor=#000000;fillColor=none;image=https://codereaper-image-bed.oss-cn-shenzhen.aliyuncs.com/img/f64829ffc2e9e006b090f9aae51035ee.png;imageBorder=default;" vertex="1" parent="1">
                    <mxGeometry x="610" y="1460" width="212" height="260" as="geometry"/>
                </mxCell>
                <mxCell id="90" value="&lt;div&gt;Always策略：每次写入 AOF 文件数据后，就执行 fsync() 函数；&lt;/div&gt;&lt;div&gt;Everysec策略：创建一个异步任务来执行 fsync() 函数；&lt;/div&gt;&lt;div&gt;No 策略：永不执行 fsync() 函数;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#ffe6cc;strokeColor=#d79b00;sketch=1;align=left;" vertex="1" parent="1">
                    <mxGeometry x="339.82" y="1720" width="350" height="66" as="geometry"/>
                </mxCell>
                <mxCell id="94" style="edgeStyle=none;rounded=0;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontColor=#000000;" edge="1" parent="1" source="92" target="93">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="98" style="edgeStyle=none;rounded=0;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontColor=#000000;" edge="1" parent="1" source="92" target="97">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="102" style="edgeStyle=none;rounded=0;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontColor=#000000;" edge="1" parent="1" source="92" target="101">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="107" style="edgeStyle=none;rounded=0;sketch=1;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontColor=#000000;" edge="1" parent="1" source="92" target="105">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="92" value="&lt;div&gt;AOF 重写机制&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#ffe6cc;strokeColor=#d79b00;" vertex="1" parent="1">
                    <mxGeometry x="40" y="1970" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="96" style="edgeStyle=none;rounded=0;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontColor=#000000;" edge="1" parent="1" source="93" target="95">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="93" value="&lt;div&gt;解决的问题&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#b1ddf0;strokeColor=#10739e;" vertex="1" parent="1">
                    <mxGeometry x="180" y="1850" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="95" value="&lt;div&gt;避免AOF文件越写越大，压缩AOF文件大小&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#ffe6cc;strokeColor=#d79b00;sketch=1;" vertex="1" parent="1">
                    <mxGeometry x="324.57" y="1840" width="176" height="50" as="geometry"/>
                </mxCell>
                <mxCell id="100" style="edgeStyle=none;rounded=0;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontColor=#000000;" edge="1" parent="1" source="97" target="99">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="97" value="&lt;div&gt;案例&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
                    <mxGeometry x="180" y="1970" width="70" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="99" value="" style="shape=image;imageAspect=0;aspect=fixed;verticalLabelPosition=bottom;verticalAlign=top;comic=0;sketch=1;fontColor=#000000;fillColor=none;image=https://codereaper-image-bed.oss-cn-shenzhen.aliyuncs.com/img/723d6c580c05400b3841bc69566dd61b.png;imageBorder=default;" vertex="1" parent="1">
                    <mxGeometry x="315" y="1900" width="669.7" height="170" as="geometry"/>
                </mxCell>
                <mxCell id="104" style="edgeStyle=none;rounded=0;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontColor=#000000;" edge="1" parent="1" source="101" target="103">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="101" value="&lt;div&gt;机制说明&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
                    <mxGeometry x="180" y="2100" width="70" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="103" value="&lt;div&gt;① 读取当前数据库中的所有键值对&lt;/div&gt;&lt;div&gt;② 将&lt;b&gt;每一个键值对用一条命令记录&lt;/b&gt;到「新的AOF文件」&lt;/div&gt;&lt;div&gt;③ 将新的AOF文件替换掉现有的AOF文件&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#ffe6cc;strokeColor=#d79b00;sketch=1;align=left;" vertex="1" parent="1">
                    <mxGeometry x="314.91" y="2085" width="305" height="60" as="geometry"/>
                </mxCell>
                <mxCell id="110" style="edgeStyle=none;rounded=0;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontColor=#000000;" edge="1" parent="1" source="105" target="109">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="113" style="edgeStyle=none;rounded=0;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontColor=#000000;dashed=1;" edge="1" parent="1" source="105" target="111">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="105" value="后台重写" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#b0e3e6;strokeColor=#0e8088;" vertex="1" parent="1">
                    <mxGeometry x="40" y="2220" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="114" style="edgeStyle=none;rounded=0;sketch=1;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontColor=#000000;" edge="1" parent="1" source="109" target="111">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="109" value="重写过程很耗时，所以不能放在主进程里进行，故使用&lt;b&gt;后台子进程bgrewriteaof来完成&lt;/b&gt;" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="1">
                    <mxGeometry x="180" y="2170" width="180" height="50" as="geometry"/>
                </mxCell>
                <mxCell id="116" style="edgeStyle=none;rounded=0;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontColor=#000000;" edge="1" parent="1" source="111" target="115">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="118" style="edgeStyle=none;rounded=0;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontColor=#000000;" edge="1" parent="1" source="111" target="117">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="111" value="好处" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
                    <mxGeometry x="234.95" y="2250" width="70.09" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="115" value="子进程进行AOF重写期间，主进程可以继续处理命令请求，从而&lt;b&gt;避免阻塞主进程&lt;/b&gt;" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#ffe6cc;strokeColor=#d79b00;sketch=1;" vertex="1" parent="1">
                    <mxGeometry x="388.91" y="2210" width="231.09" height="50" as="geometry"/>
                </mxCell>
                <mxCell id="120" style="edgeStyle=orthogonalEdgeStyle;rounded=0;sketch=1;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontColor=#000000;dashed=1;" edge="1" parent="1" source="117" target="119">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="117" value="子进程使用&lt;b&gt;写时复制&lt;/b&gt;的机制&lt;b&gt;避免了数据加锁&lt;/b&gt;，保证了子进程AOF重写时&lt;b&gt;主进程性能不被影响&lt;/b&gt;" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#ffe6cc;strokeColor=#d79b00;sketch=1;" vertex="1" parent="1">
                    <mxGeometry x="388.82" y="2270" width="251.18" height="50" as="geometry"/>
                </mxCell>
                <mxCell id="122" style="rounded=0;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontColor=#000000;" edge="1" parent="1" source="119" target="121">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="119" value="fork系统调用写时复制" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#ffe6cc;strokeColor=#d79b00;" vertex="1" parent="1">
                    <mxGeometry x="40.00000000000003" y="2459.59" width="75.14" height="40" as="geometry"/>
                </mxCell>
                <mxCell id="126" style="edgeStyle=none;rounded=0;sketch=1;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontColor=#000000;" edge="1" parent="1" source="121" target="123">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="128" style="edgeStyle=none;rounded=0;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontColor=#000000;" edge="1" parent="1" source="121" target="125">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="121" value="" style="shape=image;imageAspect=0;aspect=fixed;verticalLabelPosition=bottom;verticalAlign=top;comic=0;sketch=1;fontColor=#000000;fillColor=none;image=https://codereaper-image-bed.oss-cn-shenzhen.aliyuncs.com/img/5a1f2a90b5f3821c19bea3b7a5f27fa1.png;imageBorder=default;" vertex="1" parent="1">
                    <mxGeometry x="170" y="2339.59" width="310" height="283.18" as="geometry"/>
                </mxCell>
                <mxCell id="123" value="&lt;div style=&quot;text-align: left&quot;&gt;&lt;span&gt;- bgrewriteaof子线程在重写AOF期间，只有主线程执行写命令时，对应的数据页会进行复制，修改页表中的一项，而其他项都不会发生改变。&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;- 因而当重写AOF时如果主进程修改的数据较少，其实&lt;b&gt;只需要少量的额外内存空间&lt;/b&gt;即可完成重写操作&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#ffe6cc;strokeColor=#d79b00;sketch=1;" vertex="1" parent="1">
                    <mxGeometry x="390" y="2690" width="270" height="85.41" as="geometry"/>
                </mxCell>
                <mxCell id="127" style="edgeStyle=none;rounded=0;sketch=1;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.481;entryY=0;entryDx=0;entryDy=0;entryPerimeter=0;fontColor=#000000;" edge="1" parent="1" source="125" target="123">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="125" value="" style="shape=image;imageAspect=0;aspect=fixed;verticalLabelPosition=bottom;verticalAlign=top;comic=0;sketch=1;fontColor=#000000;fillColor=none;image=https://codereaper-image-bed.oss-cn-shenzhen.aliyuncs.com/img/d4cfac545377b54dd035c775603b4936.png;imageBorder=default;" vertex="1" parent="1">
                    <mxGeometry x="520" y="2339.5899999999997" width="384.17" height="280" as="geometry"/>
                </mxCell>
                <mxCell id="131" style="edgeStyle=none;rounded=0;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontColor=#000000;" edge="1" parent="1" source="129" target="130">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="133" style="edgeStyle=none;rounded=0;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontColor=#000000;" edge="1" parent="1" source="129" target="132">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="129" value="AOF重写缓冲区" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#ffe6cc;strokeColor=#d79b00;" vertex="1" parent="1">
                    <mxGeometry x="40" y="2850" width="90" height="40" as="geometry"/>
                </mxCell>
                <mxCell id="130" value="作用：用于解决在AOF重写过程中主进程写入数据后&lt;b&gt;内存数据和AOF数据不一致&lt;/b&gt;的情况" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;" vertex="1" parent="1">
                    <mxGeometry x="208.91" y="2790" width="180" height="60" as="geometry"/>
                </mxCell>
                <mxCell id="135" style="edgeStyle=none;rounded=0;sketch=1;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontColor=#000000;" edge="1" parent="1" source="132" target="134">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="132" value="" style="shape=image;imageAspect=0;aspect=fixed;verticalLabelPosition=bottom;verticalAlign=top;comic=0;sketch=1;fontColor=#000000;fillColor=none;image=https://codereaper-image-bed.oss-cn-shenzhen.aliyuncs.com/img/202105270918298.png;imageBorder=default;" vertex="1" parent="1">
                    <mxGeometry x="190" y="2860" width="581.09" height="390" as="geometry"/>
                </mxCell>
                <mxCell id="137" style="edgeStyle=none;rounded=0;sketch=1;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontColor=#000000;" edge="1" parent="1" source="134" target="136">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="134" value="在bgrewriteaof子进程执行AOF重写期间：&lt;br&gt;&lt;div&gt;1. 执行客户端发来的命令；&lt;/div&gt;&lt;div&gt;2. 将执行后的写命令追加到 「AOF 缓冲区」；&lt;/div&gt;&lt;div&gt;3. 将执行后的写命令追加到 「AOF 重写缓冲区」；&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#ffe6cc;strokeColor=#d79b00;align=left;sketch=1;" vertex="1" parent="1">
                    <mxGeometry x="800" y="3015" width="280" height="80" as="geometry"/>
                </mxCell>
                <mxCell id="136" value="AOF重写完成后，主进程将AOF重写缓冲区的数据追加到新的AOF文件尾" style="rounded=0;whiteSpace=wrap;html=1;comic=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;sketch=1;" vertex="1" parent="1">
                    <mxGeometry x="837.5" y="3130" width="205" height="50" as="geometry"/>
                </mxCell>
            </root>
        </mxGraphModel>
    </diagram>
</mxfile>